{# macros/spell_casting.lua.jinja2 - Spell timer and casting system #}

{% macro spell_cast_function(boss, ability, phase) %}
-- {{ ability.name }} ({{ ability.description }})
function Boss.{{ ability.func_name }}(event, delay, repeats, creature)
    {% if phase %}
    local current_phase = creature:GetData("PHASE")

    -- Only in Phase {{ phase.phase_id }}
    if current_phase ~= {{ phase.phase_id }} then
        return
    end
    {% endif %}

    {% if ability.cast_time is defined and ability.cast_time %}
    -- Don't cast if already casting
    if creature:IsCasting() then
        return
    end
    {% endif %}

    {% if ability.targeting.type == 'current' %}
    -- Target current victim (tank)
    local target = creature:GetVictim()
    {% elif ability.targeting.type == 'random_player' %}
    -- Target random player
    local target = Boss.GetRandomPlayer(creature)
    {% elif ability.targeting.type == 'aoe' or ability.targeting.type == 'self' %}
    -- Target self (AoE effect)
    local target = creature
    {% endif %}

    if target then
        creature:CastSpell(target, {{ ability.spell_id }}, false)
    end

    -- Reschedule
    {% if ability.timer.min == ability.timer.max %}
    creature:RegisterEvent(Boss.{{ ability.func_name }}, {{ ability.timer.min }}, 0)
    {% else %}
    local next_cast = math.random({{ ability.timer.min }}, {{ ability.timer.max }})
    creature:RegisterEvent(Boss.{{ ability.func_name }}, next_cast, 0)
    {% endif %}
end
{% endmacro %}
