-- {{ instance.display_name }} Instance Script
-- AUTO-GENERATED by world_builder.script_generator
-- Map ID: {{ instance.map_id }}
-- COMPLETE AND DEPLOYABLE - NO MANUAL CHANGES REQUIRED

local INSTANCE = {}

-- ========================================
-- ENCOUNTER CONSTANTS
-- ========================================
{% for boss in instance.bosses %}
INSTANCE.{{ boss.encounter_name }} = {{ boss.encounter_id }}
{% endfor %}
INSTANCE.MAX_ENCOUNTERS = {{ instance.bosses | length }}

-- ========================================
-- DOOR ENTRIES
-- ========================================
{% for door in instance.doors %}
INSTANCE.{{ door.const_name }} = {{ door.entry }}
{% endfor %}

-- ========================================
-- BOSS ENTRIES
-- ========================================
{% for boss in instance.bosses %}
INSTANCE.NPC_{{ boss.encounter_name | replace('BOSS_', '') }} = {{ boss.entry }}
{% endfor %}

-- ========================================
-- INSTANCE DATA KEYS
-- ========================================
local DATA_ENCOUNTER_STATE = "ENCOUNTER_STATE"
local DATA_DOOR_STATE = "DOOR_STATE"

-- ========================================
-- INSTANCE INITIALIZATION
-- ========================================
function INSTANCE.OnCreate(event, instance)
    -- Initialize encounter state (bitmask: 0 = not killed, 1 = killed)
    instance:SetData(DATA_ENCOUNTER_STATE, 0)

    -- Lock all doors initially
{% for door in instance.doors %}
    INSTANCE.SetDoorState(instance, INSTANCE.{{ door.const_name }}, 0)  -- closed
{% endfor %}

    -- Initialize door state tracking
    instance:SetData(DATA_DOOR_STATE, 0)
end

-- ========================================
-- DOOR MANAGEMENT
-- ========================================
function INSTANCE.SetDoorState(instance, door_entry, state)
    local door = instance:GetGameObject(door_entry)
    if door then
        door:SetGoState(state)  -- 0 = closed, 1 = open
    end
end

function INSTANCE.UnlockDoor(instance, door_entry)
    INSTANCE.SetDoorState(instance, door_entry, 1)

    -- Update door state bitmask
    local door_state = instance:GetData(DATA_DOOR_STATE) or 0
{% for door in instance.doors %}
{% if loop.first %}
    if door_entry == INSTANCE.{{ door.const_name }} then
        door_state = bit.bor(door_state, {{ 2 ** loop.index0 }})
{% else %}
    elseif door_entry == INSTANCE.{{ door.const_name }} then
        door_state = bit.bor(door_state, {{ 2 ** loop.index0 }})
{% endif %}
{% endfor %}
    end
    instance:SetData(DATA_DOOR_STATE, door_state)
end

-- ========================================
-- ENCOUNTER STATE MANAGEMENT
-- ========================================
function INSTANCE.SetBossState(instance, encounter_id, killed)
    local state = instance:GetData(DATA_ENCOUNTER_STATE) or 0

    if killed then
        -- Set encounter bit
        state = bit.bor(state, bit.lshift(1, encounter_id))
        instance:SetData(DATA_ENCOUNTER_STATE, state)

        -- Unlock corresponding door
{% for door in instance.doors %}
{% if loop.first %}
        if encounter_id == INSTANCE.{{ instance.bosses[door.unlock_on_encounter].encounter_name }} then
            INSTANCE.UnlockDoor(instance, INSTANCE.{{ door.const_name }})
{% else %}
        elseif encounter_id == INSTANCE.{{ instance.bosses[door.unlock_on_encounter].encounter_name }} then
            INSTANCE.UnlockDoor(instance, INSTANCE.{{ door.const_name }})
{% endif %}
{% endfor %}
        end

        -- Save instance data
        instance:SaveInstanceData()
    end
end

function INSTANCE.IsBossKilled(instance, encounter_id)
    local state = instance:GetData(DATA_ENCOUNTER_STATE) or 0
    return bit.band(state, bit.lshift(1, encounter_id)) ~= 0
end

-- ========================================
-- INSTANCE DATA PERSISTENCE
-- ========================================
function INSTANCE.OnSave(event, instance)
    local state = instance:GetData(DATA_ENCOUNTER_STATE) or 0
    local door_state = instance:GetData(DATA_DOOR_STATE) or 0

    -- Save data (format: "encounterState doorState")
    return tostring(state) .. " " .. tostring(door_state)
end

function INSTANCE.OnLoad(event, instance, data)
    if not data or data == "" then
        return
    end

    -- Parse saved data
    local state, door_state = data:match("(%d+) (%d+)")
    state = tonumber(state) or 0
    door_state = tonumber(door_state) or 0

    -- Restore encounter state
    instance:SetData(DATA_ENCOUNTER_STATE, state)
    instance:SetData(DATA_DOOR_STATE, door_state)

    -- Restore door states based on killed bosses
{% for door in instance.doors %}
    if INSTANCE.IsBossKilled(instance, INSTANCE.{{ instance.bosses[door.unlock_on_encounter].encounter_name }}) then
        INSTANCE.SetDoorState(instance, INSTANCE.{{ door.const_name }}, 1)
    end
{% endfor %}
end

-- ========================================
-- CREATURE REGISTRATION
-- ========================================
function INSTANCE.OnCreatureCreate(event, instance, creature)
    local entry = creature:GetEntry()

    -- Register bosses for instance tracking
{% for boss in instance.bosses %}
{% if loop.first %}
    if entry == INSTANCE.NPC_{{ boss.encounter_name | replace('BOSS_', '') }} then
{% else %}
    elseif entry == INSTANCE.NPC_{{ boss.encounter_name | replace('BOSS_', '') }} then
{% endif %}
        instance:SetData("BOSS_" .. entry, creature:GetGUID())
{% endfor %}
    end
end

-- ========================================
-- EVENT REGISTRATION
-- ========================================
RegisterInstanceEvent({{ instance.map_id }}, 1, INSTANCE.OnCreate)         -- INSTANCE_EVENT_ON_INITIALIZE
RegisterInstanceEvent({{ instance.map_id }}, 3, INSTANCE.OnCreatureCreate) -- INSTANCE_EVENT_ON_CREATURE_CREATE
RegisterInstanceEvent({{ instance.map_id }}, 5, INSTANCE.OnLoad)           -- INSTANCE_EVENT_ON_LOAD
RegisterInstanceEvent({{ instance.map_id }}, 6, INSTANCE.OnSave)           -- INSTANCE_EVENT_ON_SAVE
